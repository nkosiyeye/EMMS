@using EMMS.Utility
@using Newtonsoft.Json
@using static EMMS.Models.Enumerators
@model EMMS.ViewModels.IndexModel;

@{
    ViewData["Title"] = "Home Page";
    ViewData["active"] = "active";
    var isAdmin = ViewBag._currrentUserRole.UserType == Enumerators.UserType.Administrator;
}

<!-- Dashboard Header -->
<div class="mb-4">
    <div class="card-body">

        <!-- Dashboard Summary -->
        <div class="row g-3 mb-3">
            <a asp-controller="AssetManagement" asp-action="Index" class="col-md-6 col-lg-3 col-xl-3">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-header bg-info text-white">Total Assets</div>
                    <div class="card-body">
                        <h2 class="card-title fw-bold">@Model.TotalAssets</h2>
                        <p class="card-text text-muted">Assets currently being tracked.</p>
                    </div>
                </div>
            </a>
            <a asp-controller="JobManagement" asp-action="manageJobs" class="col-md-6 col-lg-3 col-xl-3">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-header bg-danger text-white">Open Requests</div>
                    <div class="card-body">
                        <h2 class="card-title fw-bold">@Model.OpenWorkRequestsCount</h2>
                        <p class="card-text text-muted">Work requests that are still open.</p>
                    </div>
                </div>
            </a>


            <div class="col-md-6 col-lg-3 col-xl-3">
                <a asp-controller="JobManagement" asp-action="Index" class="card text-center h-100 shadow-sm">
                    <div class="card-header bg-success text-white">Completed Jobs</div>
                    <div class="card-body">
                        <h2 class="card-title fw-bold">@Model.CompletedJobs</h2>
                        <p class="card-text text-muted">Jobs successfully completed.</p>
                    </div>
                </a>
            </div>

            <div class="col-md-6 col-lg-3 col-xl-3">
                <a asp-controller="JobManagement" asp-action="manageJobs" class="card text-center h-100 shadow-sm">
                    <div class="card-header bg-warning text-white">Pending Jobs</div>
                    <div class="card-body">
                        <h2 class="card-title fw-bold">@Model.PendingJobs</h2>
                        <p class="card-text text-muted">Jobs awaiting approval or action.</p>
                    </div>
                </a>
            </div>
        </div>

        <!-- Equipment Service Due Table -->
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">Equipments Due for Service</span>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped" id="assetTable">
                        <thead class="table-light">
                            <tr>
                                <th>Tag</th>
                                <th>Category</th>
                                <th>Item Name</th>
                                <th>Vendor</th>
                                <th>Service Provider</th>
                                <th>Procurement Status</th>
                                <th>Location</th>
                                <th>Functional Status</th>
                                <th>Service Due</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var asset in Model.assets)
                            {
                                var lastMove = asset.LastMovement;
                                <tr>
                                    <td>@asset.Asset.AssetTagNumber</td>
                                    <td>@(Format.FormatCategory(asset.Asset?.Category?.Name))</td>
                                    <td>@asset.Asset?.SubCategory?.Name</td>
                                    <td>@asset.Asset.Vendor?.Name</td>
                                    <td>@asset.Asset.ServiceProvider?.Name</td>
                                    <td>@Format.DisplayProcurementStatus((ProcurementStatus)asset.Asset.StatusId)</td>
                                    <td>
                                        @if (lastMove != null)
                                        {
                                            @(lastMove.Facility?.FacilityName ?? lastMove.ServicePoint?.Name ?? "N/A")
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td>@Format.DisplayFunctionalStatus(lastMove?.FunctionalStatus)</td>
                                    <td>
                                        @(asset.Asset?.NextServiceDate != null
                                            ? DateOnly.FromDateTime((DateTime)asset.Asset.NextServiceDate)
                                            : "-")
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fa-solid fa-ellipsis"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li class="@(lastMove != null ? "d-none" : "")">
                                                    <a class="dropdown-item" asp-controller="AssetManagement" asp-action="edit" asp-route-id="@asset.Asset.AssetId">
                                                        <i class="fa fa-edit me-1"></i> Edit Asset
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" asp-controller="AssetManagement" asp-action="detail" asp-route-id="@asset.Asset.AssetId">
                                                        <i class="fa fa-eye me-1"></i> View Asset
                                                    </a>
                                                </li>
                                                <li class="@(lastMove?.Reason == Enumerators.MovementReason.Decommission ? "d-none" : "")">
                                                    <a class="dropdown-item" asp-controller="JobManagement" asp-action="AutomateServiceRequest" asp-route-id="@asset.Asset.AssetId">
                                                        <i class="fa fa-toolbox me-1"></i> Service Request
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Toast Notification -->
@if (TempData["Notification"] != null)
{
    var notification = JsonConvert.DeserializeObject<ToastNotification>(TempData["Notification"].ToString());
    var className = notification?.Type switch
    {
        NotificationType.Error => "error-notification notification",
        NotificationType.Success => "success-notification notification",
        _ => "notification"
    };

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            Toastify({
                text: "@notification?.Message",
                duration: 8000,
                close: true,
                gravity: "top",
                position: "center",
                className: "@className"
            }).showToast();
        });
    </script>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#assetTable').DataTable({
                pageLength: 10,
                responsive: true
            });
        });
    </script>
}



